// Slime Kingdom - Prisma Schema
// Matches db/init_db.sql

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PLAYERS (Account/Auth)
// ============================================
model Player {
  id           String    @id @default(uuid())
  username     String    @unique @db.VarChar(32)
  email        String?   @unique @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  createdAt    DateTime  @default(now()) @map("created_at")
  lastLogin    DateTime? @map("last_login")
  isOnline     Boolean   @default(false) @map("is_online")

  // Relations
  character      Character?
  hostedSessions GameSession[]    @relation("HostedSessions")
  sessionPlayers SessionPlayer[]

  @@map("players")
}

// ============================================
// CHARACTERS (The Hero)
// ============================================
model Character {
  id       String @id @default(uuid())
  playerId String @unique @map("player_id")
  name     String @db.VarChar(32)
  sprite   String @default("knight") @db.VarChar(32)

  // Position & Scene
  currentScene String @default("TownScene") @map("current_scene") @db.VarChar(32)
  posX         Float  @default(160) @map("pos_x")
  posY         Float  @default(160) @map("pos_y")
  dungeonFloor Int    @default(1) @map("dungeon_floor")

  // Core Stats
  level      Int @default(1)
  experience Int @default(0)

  // Health
  hp    Int @default(10)
  maxHp Int @default(10) @map("max_hp")

  // Mana (starting characters have 3 MP)
  mp    Int @default(3)
  maxMp Int @default(3) @map("max_mp")

  // Combat Stats (base values before equipment)
  strength Int @default(1)  // Base physical power
  defense  Int @default(0)  // Base defense (before gear)
  magic    Int @default(1)  // Magic power
  speed    Int @default(1)

  // Currency
  gold Int @default(0)

  // Statistics tracking
  monstersKilled    Int @default(0) @map("monsters_killed")
  battlesWon        Int @default(0) @map("battles_won")
  battlesLost       Int @default(0) @map("battles_lost")
  timesFled         Int @default(0) @map("times_fled")
  damageDealt       Int @default(0) @map("damage_dealt")
  damageTaken       Int @default(0) @map("damage_taken")
  successfulParries Int @default(0) @map("successful_parries")
  spellsCast        Int @default(0) @map("spells_cast")
  itemsUsed         Int @default(0) @map("items_used")
  goldEarned        Int @default(0) @map("gold_earned")
  deepestFloor      Int @default(1) @map("deepest_floor")
  playTimeSeconds   Int @default(0) @map("play_time_seconds")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  player         Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)
  inventory      Inventory[]
  equipment      Equipment[]
  combatLogs     CombatLog[]
  sessionPlayers SessionPlayer[]

  @@map("characters")
}

// ============================================
// ITEM DEFINITIONS (Item Catalog)
// ============================================
model ItemDefinition {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(64)
  description String?
  sprite      String  @db.VarChar(32)
  itemType    String  @map("item_type") @db.VarChar(32)

  // Equipment slot (null for consumables/key items)
  slot String? @db.VarChar(32)

  // Stat bonuses (for equipment)
  attackBonus  Int @default(0) @map("attack_bonus")
  defenseBonus Int @default(0) @map("defense_bonus")
  magicBonus   Int @default(0) @map("magic_bonus")
  speedBonus   Int @default(0) @map("speed_bonus")
  maxHpBonus   Int @default(0) @map("max_hp_bonus")

  // Consumable effects
  healAmount  Int @default(0) @map("heal_amount")
  manaRestore Int @default(0) @map("mana_restore")

  // Shop info
  buyPrice  Int @default(0) @map("buy_price")
  sellPrice Int @default(0) @map("sell_price")

  isStackable Boolean @default(false) @map("is_stackable")
  maxStack    Int     @default(1) @map("max_stack")

  // Relations
  inventory Inventory[]
  equipment Equipment[]

  @@map("item_definitions")
}

// ============================================
// INVENTORY (Items owned by character)
// ============================================
model Inventory {
  id          String @id @default(uuid())
  characterId String @map("character_id")
  itemId      Int    @map("item_id")
  quantity    Int    @default(1)

  // Relations
  character Character      @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item      ItemDefinition @relation(fields: [itemId], references: [id])

  @@unique([characterId, itemId])
  @@map("inventory")
}

// ============================================
// EQUIPMENT (Currently equipped items)
// ============================================
model Equipment {
  id          String  @id @default(uuid())
  characterId String  @map("character_id")
  slot        String  @db.VarChar(32)
  itemId      Int?    @map("item_id")

  // Relations
  character Character       @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item      ItemDefinition? @relation(fields: [itemId], references: [id])

  @@unique([characterId, slot])
  @@map("equipment")
}

// ============================================
// GAME SESSIONS (Active multiplayer sessions)
// ============================================
model GameSession {
  id           String   @id @default(uuid())
  hostPlayerId String   @map("host_player_id")
  sessionCode  String?  @unique @map("session_code") @db.VarChar(8)
  maxPlayers   Int      @default(4) @map("max_players")
  currentScene String   @default("TownScene") @map("current_scene") @db.VarChar(32)
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  hostPlayer     Player          @relation("HostedSessions", fields: [hostPlayerId], references: [id])
  sessionPlayers SessionPlayer[]

  @@map("game_sessions")
}

// ============================================
// SESSION PLAYERS (Players in a session)
// ============================================
model SessionPlayer {
  sessionId   String   @map("session_id")
  playerId    String   @map("player_id")
  characterId String   @map("character_id")
  socketId    String?  @map("socket_id") @db.VarChar(64)
  joinedAt    DateTime @default(now()) @map("joined_at")

  // Relations
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  player    Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  character Character   @relation(fields: [characterId], references: [id])

  @@id([sessionId, playerId])
  @@map("session_players")
}

// ============================================
// ENEMY DEFINITIONS (Monster Catalog)
// ============================================
model EnemyDefinition {
  id          Int    @id @default(autoincrement())
  name        String @db.VarChar(64)
  displayName String @map("display_name") @db.VarChar(64)
  sprite      String @db.VarChar(32)

  // Base Stats
  baseHp  Int @default(3) @map("base_hp")
  attack  Int @default(1)
  defense Int @default(0)
  speed   Int @default(1)

  // Rewards
  baseXp   Int @default(10) @map("base_xp")
  baseGold Int @default(5) @map("base_gold")

  // Encounter settings
  minFloor Int @default(1) @map("min_floor")

  // Attack pattern for parry system
  attackPattern   String @default("straight") @map("attack_pattern") @db.VarChar(32)
  approachSpeed   Int    @default(600) @map("approach_speed")
  telegraphBlinks Int    @default(2) @map("telegraph_blinks")

  @@map("enemy_definitions")
}

// ============================================
// COMBAT LOG (Track battles)
// ============================================
model CombatLog {
  id               String   @id @default(uuid())
  characterId      String   @map("character_id")
  enemyType        String   @map("enemy_type") @db.VarChar(32)
  dungeonFloor     Int?     @map("dungeon_floor")
  outcome          String   @db.VarChar(16)
  experienceGained Int      @default(0) @map("experience_gained")
  goldGained       Int      @default(0) @map("gold_gained")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("combat_log")
}

// ============================================
// SPELL DEFINITIONS (Magic Catalog)
// ============================================
model SpellDefinition {
  id                   Int     @id @default(autoincrement())
  name                 String  @unique @db.VarChar(64)
  description          String?
  sprite               String  @db.VarChar(32)

  // Learning requirements
  levelRequired        Int     @default(1) @map("level_required")

  // MP cost
  mpCost               Int     @default(5) @map("mp_cost")

  // Where can it be cast?
  canUseInCombat       Boolean @default(true) @map("can_use_in_combat")
  canUseOutsideCombat  Boolean @default(false) @map("can_use_outside_combat")

  // Effects
  damage               Int     @default(0)
  healAmount           Int     @default(0) @map("heal_amount")
  effectType           String  @default("damage") @map("effect_type") @db.VarChar(32)

  // Scaling (added to base based on magic stat)
  magicScaling         Float   @default(0.5) @map("magic_scaling")

  @@map("spell_definitions")
}
